<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.topline.mappers.PurchaseMapper" >
  <resultMap id="BaseResultMap" type="com.topline.model.Purchase" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    <id column="pur_id" property="purId" jdbcType="INTEGER" />
    <result column="pur_invono" property="purInvono" jdbcType="VARCHAR" />
    <result column="pur_refNo" property="purRefno" jdbcType="VARCHAR" />
    <result column="pur_date" property="purDate"  jdbcType="DATE" />
    <result column="pur_acc_code" property="purAccCode" jdbcType="INTEGER" />
    <result column="pur_user" property="purUser" jdbcType="VARCHAR" />
    <result column="pur_status" property="purStatus" jdbcType="VARCHAR" />
    <result column="pur_posted_by" property="purPostedBy" jdbcType="VARCHAR" /> 
     <result column="pur_loc_code" property="purLocCode" jdbcType="INTEGER" />
  </resultMap> 
  <sql id="Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    <where >
      <foreach collection="example.oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    pur_id, pur_invono, pur_refNo, pur_date, pur_acc_code, pur_user, pur_status, pur_posted_by,pur_loc_code
  </sql>
  <select id="selectByExample" resultMap="BaseResultMap" parameterType="com.topline.model.PurchaseExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from inv_purchases
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    from inv_purchases
    where pur_id = #{purId,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    delete from inv_purchases
    where pur_id = #{purId,jdbcType=INTEGER}
  </delete>
  <delete id="deleteByExample" parameterType="com.topline.model.PurchaseExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    delete from inv_purchases
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="com.topline.model.Purchase" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    insert into inv_purchases (pur_id, pur_invono, pur_refNo, 
      pur_date, pur_acc_code, pur_user, 
      pur_status, pur_posted_by,pur_loc_code)
    values (#{purId,jdbcType=INTEGER}, #{purInvono,jdbcType=VARCHAR}, #{purRefno,jdbcType=VARCHAR}, 
      #{purDate,jdbcType=DATE}, #{purAccCode,jdbcType=INTEGER}, #{purUser,jdbcType=VARCHAR}, 
      #{purStatus,jdbcType=VARCHAR}, #{purPostedBy,jdbcType=VARCHAR},#{purLocCode,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" parameterType="com.topline.model.Purchase" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    insert into inv_purchases
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="purId != null" >
        pur_id,
      </if>
      <if test="purInvono != null" >
        pur_invono,
      </if>
      <if test="purRefno != null" >
        pur_refNo,
      </if>
      <if test="purDate != null" >
        pur_date,
      </if>
      <if test="purAccCode != null" >
        pur_acc_code,
      </if>
      <if test="purUser != null" >
        pur_user,
      </if>
      <if test="purStatus != null" >
        pur_status,
      </if>
      <if test="purPostedBy != null" >
        pur_posted_by,
      </if>
      <if test="purLocCode != null" >
        pur_loc_code,
      </if>
      
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="purId != null" >
        #{purId,jdbcType=INTEGER},
      </if>
      <if test="purInvono != null" >
        #{purInvono,jdbcType=VARCHAR},
      </if>
      <if test="purRefno != null" >
        #{purRefno,jdbcType=VARCHAR},
      </if>
      <if test="purDate != null" >
        #{purDate,jdbcType=DATE},
      </if>
      <if test="purAccCode != null" >
        #{purAccCode,jdbcType=INTEGER},
      </if>
      <if test="purUser != null" >
        #{purUser,jdbcType=VARCHAR},
      </if>
      <if test="purStatus != null" >
        #{purStatus,jdbcType=VARCHAR},
      </if>
      <if test="purPostedBy != null" >
        #{purPostedBy,jdbcType=VARCHAR},
      </if>
      <if test="purLocCode != null" >
         #{purLocCode,jdbcType=INTEGER}
      </if>
     
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.topline.model.PurchaseExample" resultType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    select count(*) from inv_purchases
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    update inv_purchases
    <set >
      <if test="record.purId != null" >
        pur_id = #{record.purId,jdbcType=INTEGER},
      </if>
      <if test="record.purInvono != null" >
        pur_invono = #{record.purInvono,jdbcType=VARCHAR},
      </if>
      <if test="record.purRefno != null" >
        pur_refNo = #{record.purRefno,jdbcType=VARCHAR},
      </if>
      <if test="record.purDate != null" >
        pur_date = #{record.purDate,jdbcType=DATE},
      </if>
      <if test="record.purAccCode != null" >
        pur_acc_code = #{record.purAccCode,jdbcType=INTEGER},
      </if>
      <if test="record.purUser != null" >
        pur_user = #{record.purUser,jdbcType=VARCHAR},
      </if>
      <if test="record.purStatus != null" >
        pur_status = #{record.purStatus,jdbcType=VARCHAR},
      </if>
      <if test="record.purPostedBy != null" >
        pur_posted_by = #{record.purPostedBy,jdbcType=VARCHAR},
      </if>
      <if test="record.purLocCode != null" >
        pur_loc_code = #{record.purLocCode,jdbcType=INTEGER},
      </if>
      
    </set>
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    update inv_purchases
    set pur_id = #{record.purId,jdbcType=INTEGER},
      pur_invono = #{record.purInvono,jdbcType=VARCHAR},
      pur_refNo = #{record.purRefno,jdbcType=VARCHAR},
      pur_date = #{record.purDate,jdbcType=DATE},
      pur_acc_code = #{record.purAccCode,jdbcType=INTEGER},
      pur_user = #{record.purUser,jdbcType=VARCHAR},
      pur_status = #{record.purStatus,jdbcType=VARCHAR},
      pur_posted_by = #{record.purPostedBy,jdbcType=VARCHAR},
      pur_loc_code = #{record.purLocCode,jdbcType=INTEGER}
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="com.topline.model.Purchase" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    update inv_purchases
    <set >
      <if test="purInvono != null" >
        pur_invono = #{purInvono,jdbcType=VARCHAR},
      </if>
      <if test="purRefno != null" >
        pur_refNo = #{purRefno,jdbcType=VARCHAR},
      </if>
      <if test="purDate != null" >
        pur_date = #{purDate,jdbcType=DATE},
      </if>
      <if test="purAccCode != null" >
        pur_acc_code = #{purAccCode,jdbcType=INTEGER},
      </if>
      <if test="purUser != null" >
        pur_user = #{purUser,jdbcType=VARCHAR},
      </if>
      <if test="purStatus != null" >
        pur_status = #{purStatus,jdbcType=VARCHAR},
      </if>
      <if test="purPostedBy != null" >
        pur_posted_by = #{purPostedBy,jdbcType=VARCHAR},
      </if>
      <if test="purLocCode != null" >
        pur_loc_code = #{purLocCode,jdbcType=INTEGER},
      </if>
    </set>
    where pur_id = #{purId,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.topline.model.Purchase" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jul 23 15:43:34 EAT 2015.
    -->
    update inv_purchases
    set pur_invono = #{purInvono,jdbcType=VARCHAR},
      pur_refNo = #{purRefno,jdbcType=VARCHAR},
      pur_date = #{purDate,jdbcType=DATE},
      pur_acc_code = #{purAccCode,jdbcType=INTEGER},
      pur_user = #{purUser,jdbcType=VARCHAR},
      pur_status = #{purStatus,jdbcType=VARCHAR},
      pur_posted_by = #{purPostedBy,jdbcType=VARCHAR},
      pur_loc_code = #{purLocCode,jdbcType=INTEGER}
    where pur_id = #{purId,jdbcType=INTEGER}
  </update>
  <insert id="save" parameterType="com.topline.model.Purchase" useGeneratedKeys="true" keyProperty="purId"  keyColumn="pur_id" >
    
    insert into inv_purchases (pur_invono, pur_refNo, 
      pur_date, pur_acc_code, pur_user, 
      pur_status, pur_posted_by,pur_loc_code)
    values ( #{purInvono,jdbcType=VARCHAR}, #{purRefno,jdbcType=VARCHAR}, 
      #{purDate,jdbcType=DATE}, #{purAccCode,jdbcType=INTEGER}, #{purUser,jdbcType=VARCHAR}, 
      #{purStatus,jdbcType=VARCHAR}, #{purPostedBy,jdbcType=VARCHAR},#{purLocCode,jdbcType=INTEGER})
      <selectKey keyProperty="purId" resultType="integer" order="AFTER">
            SELECT LAST_INSERT_ID();
        </selectKey>
  </insert>
   <resultMap id="BaseResultMapWrapper" extends="BaseResultMap" type="com.topline.model.wrappers.PurchaseWrapper" >    
    <result column="acc_name" property="_purAccCode" jdbcType="VARCHAR" />  
  </resultMap>
   <select id="fetchPurchases" parameterType="java.util.HashMap" resultMap="BaseResultMapWrapper" >
	   SELECT pur_id, pur_invono, pur_refNo, pur_date, pur_acc_code, pur_user, pur_status, pur_posted_by,pur_loc_code,acc_name  
	   FROM inv_purchases, inv_accounts
	   WHERE pur_acc_code=acc_code
        <if test="purStatus != null">
          AND  pur_status =  #{purStatus,jdbcType=VARCHAR}
      </if>	
      <if test="accCode !=null">
      	   AND  pur_acc_code =  #{accCode,jdbcType=INTEGER}
      </if>
      <if test="dateFrom !=null"  >
      	AND  pur_date BETWEEN  #{dateFrom,jdbcType=DATE} AND #{dateTo,jdbcType=DATE}
      </if>
      <if test="purId !=null">
      	   AND  pur_id =  #{purId,jdbcType=INTEGER}
      </if>
   </select>
    <select id="postPurchase" parameterType="java.util.HashMap" statementType="CALLABLE">    
	{ CALL post_purchases(#{v_pur_id, mode=IN, jdbcType=INTEGER},#{postedBy, mode=IN, jdbcType=VARCHAR},#{v_count, mode=OUT, jdbcType=INTEGER})}
</select> 
  <resultMap id="ResultSummaryMapper"  type="com.topline.model.ReportSummary" >    
    <result column="label" property="label" jdbcType="VARCHAR" /> 
    <result column="value" property="value" jdbcType="DECIMAL" />  
  </resultMap> 
  <select id="fetchResultSummary" parameterType="java.util.HashMap" resultMap="ResultSummaryMapper">
  	SELECT DATE_FORMAT(pur_date,'%M') as label,sum(purd_qty*purd_price) as value
		FROM inv_purchases, inv_purchases_details
		WHERE pur_id=purd_pur_id
		AND pur_status="POSTED"
		AND DATE_FORMAT(pur_date,'%Y')=DATE_FORMAT(sysdate(),'%Y')
		GROUP BY DATE_FORMAT(pur_date,'%M')
		order by DATE_FORMAT(pur_date,'%m')
  </select>
</mapper>